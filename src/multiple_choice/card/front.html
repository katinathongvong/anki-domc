<script>
    //BIG TODO: write better comments please
    //use JSDOC: https://jsdoc.app/about-getting-started.html
    // Loading Persistence
    // https://github.com/SimonLammer/anki-persistence
    // v0.5.2 - https://github.com/SimonLammer/anki-persistence/blob/62463a7f63e79ce12f7a622a8ca0beb4c1c5d556/script.js
    if (void 0 === window.Persistence) { var _persistenceKey = "github.com/SimonLammer/anki-persistence/", _defaultKey = "_default"; if (window.Persistence_sessionStorage = function () { var e = !1; try { "object" == typeof window.sessionStorage && (e = !0, this.clear = function () { for (var e = 0; e < sessionStorage.length; e++) { var t = sessionStorage.key(e); 0 == t.indexOf(_persistenceKey) && (sessionStorage.removeItem(t), e--) } }, this.setItem = function (e, t) { void 0 == t && (t = e, e = _defaultKey), sessionStorage.setItem(_persistenceKey + e, JSON.stringify(t)) }, this.getItem = function (e) { return void 0 == e && (e = _defaultKey), JSON.parse(sessionStorage.getItem(_persistenceKey + e)) }, this.removeItem = function (e) { void 0 == e && (e = _defaultKey), sessionStorage.removeItem(_persistenceKey + e) }) } catch (e) { } this.isAvailable = function () { return e } }, window.Persistence_windowKey = function (e) { var t = window[e], i = !1; "object" == typeof t && (i = !0, this.clear = function () { t[_persistenceKey] = {} }, this.setItem = function (e, i) { void 0 == i && (i = e, e = _defaultKey), t[_persistenceKey][e] = i }, this.getItem = function (e) { return void 0 == e && (e = _defaultKey), t[_persistenceKey][e] || null }, this.removeItem = function (e) { void 0 == e && (e = _defaultKey), delete t[_persistenceKey][e] }, void 0 == t[_persistenceKey] && this.clear()), this.isAvailable = function () { return i } }, window.Persistence = new Persistence_sessionStorage, Persistence.isAvailable() || (window.Persistence = new Persistence_windowKey("py")), !Persistence.isAvailable()) { var titleStartIndex = window.location.toString().indexOf("title"), titleContentIndex = window.location.toString().indexOf("main", titleStartIndex); titleStartIndex > 0 && titleContentIndex > 0 && titleContentIndex - titleStartIndex < 10 && (window.Persistence = new Persistence_windowKey("qt")) } }
</script>

<link rel="stylesheet" href="css.css">


<!-- QUESTION PLACEHOLDER:
<p>Is this a color of the rainbow?</p>
-->

{{#Title}}<h3 id="myH1">{{Title}}</h3>{{/Title}}
{{#Question}}<p>{{Question}}</p>{{/Question}}

<div class="solutions" style="display: none;">{{Answers}}</div>

<table id="choices" style="display: none;">
    <tr id="0">
        <td id="answer_0">{{Q_1}}</td>
        <td id="feedback_0">Is a color of the rainbow.</td>
    </tr>
    <tr id="1">
        <td id="answer_1">{{Q_2}}</td>
        <td id="feedback_1">Not a color of the rainbow.</td>
    </tr>
    <tr id="2">
        <td id="answer_2">{{Q_3}}</td>
        <td id="feedback_2">Is a color of the rainbow.</td>

    </tr>
    <tr id="3">
        <td id="answer_3">{{Q_4}}</td>
        <td id="feedback_3"></td>
    </tr>
    <tr id="4">
        <td id="answer_4">{{Q_5}}</td>
        <td id="feedback_4">Is not a color of the rainbow.</td>

    </tr>
</table>


<!--
    PLACEHOLDER TEST DATA
<table id="choices" style="display: none;">
    <tr id="0">
        <td id="answer_0">red</td>
        <td id="feedback_0">Is a color of the rainbow.</td>
    </tr>
    <tr id="1">
        <td id="answer_1">periwinkle</td>
        <td id="feedback_1">Not a color of the rainbow.</td>
    </tr>
    <tr id="2">
        <td id="answer_2">blue</td>
        <td id="feedback_2">Is a color of the rainbow.</td>

    </tr>
    <tr id="3">
        <td id="answer_3">green</td>
        <td id="feedback_3"></td>
    </tr>
    <tr id="4">
        <td id="answer_4">lavender</td>
        <td id="feedback_4">Is not a color of the rainbow.</td>

    </tr>
</table>
-->

<div id="answerContainer">
    <button id="showAnswerButton">Show me an answer</button>
    <div id="buttonsAndAnswerText">
        <button id="yesButton" value="1" style="display:none;">yes</button>
        <button id="noButton" value="0" style="display:none;">no</button>
        <p id="answerText"></p>
    </div>
</div>


<script>

    function generateJSONSolutionArray() {
        console.log("generateJSONSolutionArray ran");
        const solutionArray = document.getElementById("solutions").textContent.split(" ");
        console.log("The solutionArray is: " + solutionArray)

        // create the empty array to populate
        var JSONSolutionArray = [];
        var choiceTable = document.getElementById("choices");
        for (let i = 0; i < choiceTable.rows.length; i++) {
            solutionTextCellId = "answer_" + i;
            feedbackTextCellId = "feedback_" + i;
            var solutionText = document.getElementById(solutionTextCellId).innerHTML;
            var feedbackText = document.getElementById(feedbackTextCellId).innerHTML;
            console.log("Solution text");
            console.log(solutionText);
            var tempJSON = {
                "choice": solutionText,
                "solution": solutionArray[i],
                "userAnswer": "",
                "feedback": feedbackText,
                "isUserAnswerCorrect": ""
            };

            JSONSolutionArray.push(tempJSON);
            // your code below
            console.log(JSONSolutionArray);


        }
        console.log("generated initial array");
        console.log(JSONSolutionArray);
        return JSONSolutionArray;
    }

    // Shuffle the array
    //https://raddevon.com/articles/copy-javascript-object/
    // from: https://www.freecodecamp.org/news/how-to-shuffle-an-array-of-items-using-javascript-or-typescript/
    function shuffleJSONArray(JSONArray) {

        var shuffledArray = Object.assign([], JSONArray);
        let i = JSONArray.length;
        while (i > 0) {
            const ri = Math.floor(Math.random() * i);
            i--;
            [shuffledArray[i], shuffledArray[ri]] = [shuffledArray[ri], shuffledArray[i]];
        }
        return shuffledArray;
    }

    function stripEmptyObjects(JSONArray) {

    }

    // show the initial choice after user clicks "Show me an answer"
    function generateInitialPrompt(JSONArray) {
        console.log("ran generateInitialPrompt!");
        document.getElementById("showAnswerButton").style.display = "none";
        document.getElementById("yesButton").style.display = "inline";
        document.getElementById("noButton").style.display = "inline";
        var answerTextP = document.getElementById("answerText");
        answerTextP.innerHTML = JSONArray[0]["choice"];
    }

    function showNext(JSONArray, index, userAnswer) {
        console.log("ran showNext()");
        console.log("showNext: index: " + index);
        var nextIndex = index + 1;
        console.log("UserAnswer in showNext: " + userAnswer);
        JSONArray[index]["userAnswer"] = userAnswer;

        try {
            var answerText = JSONArray[nextIndex]["choice"];
            document.getElementById("answerText").innerHTML = answerText;

        }
        catch {
            console.log("showNext: answerText: Undefined...");

        }

    }

    function checkIfAtEndOfArray(currentIndex, lastIndex) {
        console.log("running checkIfAtEndOfArray");
        console.log(currentIndex == lastIndex);
    }

    //replaces a 0 or a 1 with a yes or no
    function replaceWithYesOrNo(JSONArray) {

        for (let i = 0; i < JSONArray.length; i++) {
            console.log("currentIndex: " + i);
            if (JSONArray[i]["solution"] == "1") {
                JSONArray[i]["solution"] = "yes";
            }
            else {
                JSONArray[i]["solution"] = "no";
            }

            if (JSONArray[i]["userAnswer"] == "1") {
                JSONArray[i]["userAnswer"] = "yes";
            }
            else {
                JSONArray[i]["userAnswer"] = "no";
            }
        }

        return JSONArray;
    }

    function checkAnswers(JSONArray) {
        for (let i = 0; i < JSONArray.length; i++) {
            console.log("checkAnswers: i: " + i);
            if (JSONArray[i]["solution"] == JSONArray[i]["userAnswer"]) {
                console.log("CheckAnswer: Solution: " + JSONArray[i]["solution"]);
                console.log("CheckAnswers: userAnswer : " + JSONArray[i]["userAnswer"]);
                console.log("CheckAnsweßr: Answer marked correct!");
                JSONArray[i]["isUserAnswerCorrect"] = "✓";
            }
            else {
                console.log("CheckAnswer: Solution: " + JSONArray[i]["solution"]);
                console.log("CheckAnswers: userAnswer : " + JSONArray[i]["userAnswer"]);
                console.log("CheckAnswer: Answer marked wrong!");
                JSONArray[i]["isUserAnswerCorrect"] = "X";
            }
        }

        JSONArray = replaceWithYesOrNo(JSONArray);

        return JSONArray;
    }

    function persistAnswersWhenFinishedQuestion(JSONArray) {
        console.log("DONE!");
        document.getElementById("yesButton").style.display = "none";
        document.getElementById("noButton").style.display = "none";
        document.getElementById("answerText").innerHTML = "Please review your answers."

        var withAnswers = checkAnswers(JSONArray);
        var shuffledJSONString = JSON.stringify(withAnswers);
        //console.log(shuffledJSONString);
        Persistence.setItem('jsonArray', shuffledJSONString);
        console.log(withAnswers);
    }
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function isMobile() {
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            return true;
        } else {
            return false;
        }
    }

    function run() {
        // for previewing the cards in "Manage Note Type..."
        let DEFAULT_CARD_TYPE = 1;
        let DEFAULT_SOLUTIONS = "1 0 0 0 0";

        var JSONSolutionArray = generateJSONSolutionArray();
        console.log("running in the body...");
        console.log(JSONSolutionArray);

        //shuffle the JSON array to randomize the order of choices shown to the user
        var shuffled = shuffleJSONArray(JSONSolutionArray);

        //Strip any empty values from the JSONarray
        //copied this from somewhere but cannot find where oops!
        var strippedShuffled = shuffled.filter(object => {
            return object.choice != "";
        });

        var currentIndexInShuffled = 0;
        var endOfArray = strippedShuffled.length;
        // https://stackoverflow.com/questions/14425397/onclick-function-runs-automatically
        document.getElementById("showAnswerButton").onclick = function () {
            generateInitialPrompt(strippedShuffled);
        }


        //TODO: Generate answer container, but keep it hidden so this function works

        // console.log("while loop");
        //TODO: add to notes
        // https://stackoverflow.com/questions/3042437/how-to-change-the-commit-author-for-a-single-commit

        document.getElementById("yesButton").onclick = function () {
            if (currentIndexInShuffled < endOfArray) {
                showNext(strippedShuffled, currentIndexInShuffled, 1);
                currentIndexInShuffled++;
                //console.log(shuffled);
            }
            else {
                //TODO: take care of this terrible repeating code
                persistAnswersWhenFinishedQuestion(strippedShuffled);
            }
        }

        document.getElementById("noButton").onclick = function () {
            if (currentIndexInShuffled < endOfArray) {
                showNext(strippedShuffled, currentIndexInShuffled, 0);
                currentIndexInShuffled++;
            }
            else {
                //TODO: take care of this terrible repeating code
                persistAnswersWhenFinishedQuestion(strippedShuffled);
            }
        }

    }

    async function waitForReadyStateAndRun() {
        for (let i = 0; i < 100; i++) {
            if (document.readyState === "complete") {
                setTimeout(run(), 1000);
                break;
            }
            console.log("Document not yet fully loaded (readyState: " + document.readyState + "). Retry in 0.1s.");
            await sleep(100);
        }
    }

    /*
    The following block is inspired by Glutanimate's Cloze Overlapper card template.
    The Cloze Overlapper card template is licensed under the CC BY-SA 4.0
    license (https://creativecommons.org/licenses/by-sa/4.0/).
    */
    if (document.readyState === "complete") {
        run();
    } else {
        waitForReadyStateAndRun();
    }
</script>