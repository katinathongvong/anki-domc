<script>
    // Loading Persistence
    // https://github.com/SimonLammer/anki-persistence
    // v0.5.2 - https://github.com/SimonLammer/anki-persistence/blob/62463a7f63e79ce12f7a622a8ca0beb4c1c5d556/script.js
    if (void 0 === window.Persistence) { var _persistenceKey = "github.com/SimonLammer/anki-persistence/", _defaultKey = "_default"; if (window.Persistence_sessionStorage = function () { var e = !1; try { "object" == typeof window.sessionStorage && (e = !0, this.clear = function () { for (var e = 0; e < sessionStorage.length; e++) { var t = sessionStorage.key(e); 0 == t.indexOf(_persistenceKey) && (sessionStorage.removeItem(t), e--) } }, this.setItem = function (e, t) { void 0 == t && (t = e, e = _defaultKey), sessionStorage.setItem(_persistenceKey + e, JSON.stringify(t)) }, this.getItem = function (e) { return void 0 == e && (e = _defaultKey), JSON.parse(sessionStorage.getItem(_persistenceKey + e)) }, this.removeItem = function (e) { void 0 == e && (e = _defaultKey), sessionStorage.removeItem(_persistenceKey + e) }) } catch (e) { } this.isAvailable = function () { return e } }, window.Persistence_windowKey = function (e) { var t = window[e], i = !1; "object" == typeof t && (i = !0, this.clear = function () { t[_persistenceKey] = {} }, this.setItem = function (e, i) { void 0 == i && (i = e, e = _defaultKey), t[_persistenceKey][e] = i }, this.getItem = function (e) { return void 0 == e && (e = _defaultKey), t[_persistenceKey][e] || null }, this.removeItem = function (e) { void 0 == e && (e = _defaultKey), delete t[_persistenceKey][e] }, void 0 == t[_persistenceKey] && this.clear()), this.isAvailable = function () { return i } }, window.Persistence = new Persistence_sessionStorage, Persistence.isAvailable() || (window.Persistence = new Persistence_windowKey("py")), !Persistence.isAvailable()) { var titleStartIndex = window.location.toString().indexOf("title"), titleContentIndex = window.location.toString().indexOf("main", titleStartIndex); titleStartIndex > 0 && titleContentIndex > 0 && titleContentIndex - titleStartIndex < 10 && (window.Persistence = new Persistence_windowKey("qt")) } }
</script>

<h3 id="myH1">test title</h3>

<!-- Question placeholder -->
<p>Is this a color of the rainbow?</p>

<!--
    {{#Title}}<h3 id="myH1">{{Title}}</h3>{{/Title}}
{{#Question}}<p>{{Question}}</p>{{/Question}}
-->

<div class="tappable">
    <table style="border: 1px solid black" id="qtable"></table>
</div>

<!--
    Placeholder for question array
-->

<!-- 
<div class="test" id="Q_solutions">{{Answers}}</div>
-->

<div class="test" id="solutions">1 1 1 0 1</div>
<!--
    <div class="hidden" id="Card_Type">{{QType (0=kprim,1=mc,2=sc)}}</div>
-->

<!-- 
<div class="test" id="Card_Type">0</div>
<div class="test" id="Q_1">red</div>
<div class="test" id="Q_2">blue</div>
<div class="test" id="Q_3">green</div>
<div class="test" id="Q_4">periwinkle</div>
<div class="test" id="Q_5">indigo</div>
-->

<p>answer test table</p>
<table id="choices" style="border: 1px solid">
    <tr id ="0">
        <td id="answer_0">red</td>
    </tr>
    <tr id="1">
        <td id="answer_1">blue</td>
    </tr>
    <tr id="2">
        <td id="answer_2">green</td>
    </tr>
    <tr id="3">
        <td id="answer_3">periwinkle</td>
    </tr>
    <tr id="4">
        <td id="answer_4">indigo</td>
    </tr>
</table>

<div id="answerContainer">
    <button id="showAnswerButton">Show me an answer</button>
    <div id="buttonsAndAnswerText">
        <button id="yesButton" value="1" style="display:none;">yes</button>
        <button id="noButton" value="0" style="display:none;">no</button>
        <p id="answerText"></p>
    </div>
</div>


<script>

    function generateJSONSolutionArray(){
        console.log("generateJSONSolutionArray ran");
        const solutionArray = document.getElementById("solutions").textContent.split(" ");
        console.log("The solutionArray is: " + solutionArray)

        // create the empty array to populate
        var JSONSolutionArray = [];
        var choiceTable = document.getElementById("choices");
        for (let i = 0 ; i < choiceTable.rows.length; i++) 
            {
                console.log(i);
                currentRow = choiceTable.rows[i];
                console.log(currentRow);
                console.log("currentCell")
                currentCell = currentRow.cells;
                console.log(currentCell);
                cellId = "answer_" + i;
                var solutionText = document.getElementById(cellId).innerHTML;
                console.log("Solution text");
                console.log(solutionText);
                var tempJSON = {
                    "choice": solutionText,
                    "solution": solutionArray[i],
                    "userAnswer": ""
                };

                JSONSolutionArray.push(tempJSON);
             // your code below
                console.log(JSONSolutionArray);
                

            }
            console.log("generated initial array");
            console.log(JSONSolutionArray);
            return JSONSolutionArray;
        }
    
    // Shuffle the array
    //https://raddevon.com/articles/copy-javascript-object/
    // from: https://www.freecodecamp.org/news/how-to-shuffle-an-array-of-items-using-javascript-or-typescript/
    function shuffleJSONArray(JSONArray) {

        var arrCopy = Object.assign([], JSONArray);
        let i = JSONArray.length;
  while (i > 0) {
    const ri = Math.floor(Math.random() * i);
    i--;
    [arrCopy[i], arrCopy[ri]] = [arrCopy[ri], arrCopy[i]];
  }
  return arrCopy;
  } 

    function generateInitialPrompt(JSONArray) {
        console.log("ran generateInitialPrompt!");
        document.getElementById("showAnswerButton").style.display = "none";

        document.getElementById("yesButton").style.display = "inline";
        document.getElementById("noButton").style.display = "inline";

        var answerTextP = document.getElementById("answerText");


        
        answerTextP.innerHTML = JSONArray[0]["choice"];
    }

    function showNext(JSONArray, index, userAnswer){
        console.log("ran showNext()");

        if (index != 0) {
            document.getElementById("answerText").innerHTML = JSONArray[index]["choice"];
            JSONArray[index]["userAnswer"] = userAnswer;
        }
        else {
            document.getElementById("answerText").innerHTML = JSONArray[1]["choice"];
            JSONArray[0]["userAnswer"] = userAnswer;
        }


    }

    function checkIfAtEndOfArray(currentIndex, lastIndex) {
        console.log("running checkIfAtEndOfArray");
        console.log(currentIndex == lastIndex);
    }

    //TODO: write answers to persistence

    /**
     * Get the solutions stored in the hidden div with id "Q_solutions" as Array.
     */
    function getCorrectAnswers() {
        let solutions = document.getElementById("Q_solutions").innerHTML.split(" ").map(string => Number(string));

        return solutions;
    }

    function storeCorrectAnswersInHtml(solutions) {
        document.getElementById("Q_solutions").innerHTML = solutions.join(" ");
    }

    /**
     * On checking an option this collects and stores answers in between front/back of the card.
     *
     * In case of kprim only the first box is looked at, if it isn't checked the second box has to be.
     * By default a '1' in the answers stands for 'yes' which is the first option from the left.
     */
    function onCheck(rowId) {
        // Send question table and encoded answers to Persistence along with the provided solutions
        if (Persistence.isAvailable()) {
            Persistence.clear();
            Persistence.setItem('user_answers', getUserAnswers());
            Persistence.setItem('Q_solutions', getCorrectAnswers());
            Persistence.setItem('qtable', document.getElementById("qtable").innerHTML);
        }
        // hide the table row once we click it
        document.getElementById(rowId).style.color = "transparent";
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function tickCheckboxOnNumberKeyDown(event) {
        const keyName = event.key;

        let tableBody = document.getElementById("qtable").getElementsByTagName('tbody')[0];
        var tableRows = tableBody.getElementsByTagName("tr");

        if (0 < +keyName && +keyName < 10) {
            let tableData = tableRows[+keyName - 1].getElementsByTagName("td")[0];
            let tableRow = tableData.getElementsByTagName("input")[0];
            tableRow.checked = !tableRow.checked;
            onCheck();
        }
    }

    // addCheckboxTickingShortcuts is an easy approach on using only the keyboard to toggle checkboxes in mc/sc.
    //
    // Naturally the number keys are an intuitive choice here. Unfortunately anki does capture those.
    // So the workaround is to hold the (left) 'Alt' key and then type the corresponding number to toggle the row.
    function addCheckboxTickingShortcuts() {
        document.addEventListener('keydown', tickCheckboxOnNumberKeyDown, false);
    }

    function isMobile() {
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            return true;
        } else {
            return false;
        }
    }

    function run() {
        // for previewing the cards in "Manage Note Type..."
        let DEFAULT_CARD_TYPE = 1;
        let DEFAULT_SOLUTIONS = "1 0 0 0 0";



       // setTimeout(generateTable(), 1);
        var JSONSolutionArray = generateJSONSolutionArray();
        console.log("running in the body...");
        console.log(JSONSolutionArray);

        var shuffled = shuffleJSONArray(JSONSolutionArray);
        console.log("shuffled");
        console.log(shuffled);

        var currentIndexInShuffled = 0;
        var lastIndexInShuffled = shuffled.length - 1;

        // https://stackoverflow.com/questions/14425397/onclick-function-runs-automatically
        document.getElementById("showAnswerButton").onclick = function() {
            generateInitialPrompt(shuffled);
        }


        //TODO: Generate answer container, but keep it hidden so this function works
    
       // console.log("while loop");
       //TODO: add to notes
       // https://stackoverflow.com/questions/3042437/how-to-change-the-commit-author-for-a-single-commit

        document.getElementById("yesButton").onclick = function() {
            if (currentIndexInShuffled < lastIndexInShuffled + 1) {
            showNext(shuffled, currentIndexInShuffled, 1);
            currentIndexInShuffled++;
            //console.log(shuffled);
            }
            else {
                console.log("DONE!");
                document.getElementById("yesButton").style.display = "none";
                document.getElementById("noButton").style.display = "none";
                document.getElementById("answerText").innerHTML = "Please review your answers."
                var shuffledJSONString = JSON.stringify(shuffled);
                Persistence.setItem('jsonArray', shuffledJSONString);
                console.log(shuffled);
            }
        }

        document.getElementById("noButton").onclick = function() {
            if (currentIndexInShuffled < lastIndexInShuffled + 1){
            showNext(shuffled, currentIndexInShuffled, 0);
            currentIndexInShuffled++;
            }
            else {
                console.log("DONE!");
                document.getElementById("yesButton").style.display = "none";
                document.getElementById("noButton").style.display = "none";
                document.getElementById("answerText").innerHTML = "Please review your answers."

                var shuffledJSONString = JSON.stringify(shuffled);
                Persistence.setItem('jsonArray', shuffledJSONString);
                console.log(shuffled);
            }
        }

    }

    
    
    



    async function waitForReadyStateAndRun() {
        for (let i = 0; i < 100; i++) {
            if (document.readyState === "complete") {
                setTimeout(run(), 1000);
                break;
            }
            console.log("Document not yet fully loaded (readyState: " + document.readyState + "). Retry in 0.1s.");
            await sleep(100);
        }
    }

    /*
    The following block is inspired by Glutanimate's Cloze Overlapper card template.
    The Cloze Overlapper card template is licensed under the CC BY-SA 4.0
    license (https://creativecommons.org/licenses/by-sa/4.0/).
    */
    if (document.readyState === "complete") {
        run();
    } else {
        waitForReadyStateAndRun();
    }
</script>
